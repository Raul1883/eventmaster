# Что это?
Монолит на node js и express для организации пеших прогулок. В качестве бд используется YDB, в качестве хранения yandex object storage.

## Зачем это?
Это - не мой код, я его лишь модифицировал с согласия разработчика. Изначальное состояние можно увидеть, откатившись до первого коммита (fk). 
Используется для итогового проекта по курсу, где главной целью является создать окружение в облаке для приложения, так что прошу простить некоторую архитектурную не совершенность этого приложения.
## Как это запустить?
Создать в корне .env со следующим содержимым:
```
PORT:порт
SESSION_SECRET:проивзольный случайный ключ для сессий экспресс
YDB_ENDPOINT:можно получить в servless ydb
YDB_DATABASE:можно получить в servless ydb
STORAGE_URL:путь до объектного хранилища, до папки static
```

Для локального запуска также понадобиться создать сервисный аккаунт в облаке и добавить в корень authorized_key.json, добавить в .env 

Сборка через докер:
`docker compose up --build -d`

# Terraform
## Предварительные требования
- wsl или линукс
- установленный yc `yc --version`
- установленный и добавленный в path terraform  `terraform --version`
- установленный и запущенный докер `sudo systemctl status docker`
- установленный git `git --version`
- установленный python3 `python3 --version`

## Шаги развертывания
Необходимо создать `terraform\terraform.tfvars` и поместить в него следующие переменные:
```
folder_id=""
cloud_id=""
token=""
ssh_path="<путь до файла открытого ssh ключа, .pub>"
```
Все данные можно получить командами `yc config list`
Также необходимо создать токен `yc iam create-token`, срок жизни - 12 часов и его поместить туда же.
После этого выполнить `python3 deploy.py` и ждать. Если все указанно корректно - инфраструктура будет развернута на балансировщике.

## Структура
### Хранилище
**serverless YDB** - данные приложения
**object storage** - статика (js, css, images)
**container registry** - контейнеры с приложением
### Сеть
Сеть и три подсети во всех зонах доступности
### Машины
Группа виртуальных машин на базе coi. Запускаются сразу с докер контейнерами из регистра на борту
### Балансировщик
Network load balancer 
### Сервисные аккаунты
`gyybd-project-vm-group-manager` - для развертывания группы вм
`gyybd-project-vm-manager` - для управления одной вм и управлением приложением

## Подробности о сборке
`deploy.py` - скрипт, представляющий из себя попытку в ci/cd. 
1. Создается статическая часть инфраструктуры, первый terraform apply;
2. Клонируется репозиторий с проектом;
3. Собирается и загружается в только что созданный регистр image проекта;
4. Статика из репозитория загружается в только что созданное объектное хранилище;
5. Второй terraform apply, создаются виртуальные машины с приложением на борту, балансировщики и прочее.

## Что можно сделать ещё?
Утончить роли сервисного аккаунта `gyybd-project-vm-group-manager` - сейчас он просто `editor`. Нужно использовать `compute.editor` + ещё что-то, я не успел выяснить;
Сделать vps закрытой, настроить группы безопасности, чтобы доступ был только через nlb.
Дописать адаптер для express сессий, чтобы оно работало с ydb;
